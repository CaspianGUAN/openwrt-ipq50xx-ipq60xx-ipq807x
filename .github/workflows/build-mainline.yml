name: Build Xunison D50-5G Firmware (OpenWrt mainline + QModem)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'mainline/**'
      - '.github/workflows/build-mainline.yml'

env:
  TZ: Asia/Shanghai
  OPENWRT_REPO: https://github.com/openwrt/openwrt.git
  OPENWRT_BRANCH: main
  DEVICE: xunison_d50-5g
  TARGET: qualcommax
  SUBTARGET: ipq50xx

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 330

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          path: patches-repo

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/local/share/boost /opt/hostedtoolcache/CodeQL \
            /usr/lib/jvm /usr/share/swift /usr/local/go \
            /usr/lib/mono /usr/share/java
          sudo apt-get clean
          df -h

      - name: Install build dependencies
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev \
            libssl-dev python3-setuptools rsync \
            unzip zlib1g-dev file wget curl libelf-dev \
            device-tree-compiler u-boot-tools
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

      - name: Clone OpenWrt
        run: |
          git clone --depth=1 --branch ${{ env.OPENWRT_BRANCH }} \
            ${{ env.OPENWRT_REPO }} openwrt
          echo "OpenWrt cloned: $(git -C openwrt log --oneline -1)"

      - name: Cache toolchain
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: ${{ runner.os }}-openwrt-main-toolchain-${{ hashFiles('openwrt/toolchain/**/*.mk') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-main-toolchain-

      - name: Add Xunison D50-5G device support
        run: |
          cd openwrt

          # 1. Copy DTS file
          cp ../patches-repo/mainline/dts/ipq5018-xunison-d50-5g.dts \
            target/linux/qualcommax/dts/

          # 2. Add device definition to ipq50xx.mk
          cat >> target/linux/qualcommax/image/ipq50xx.mk << 'EOF'

          define Device/xunison_d50-5g
            $(call Device/FitImageLzma)
            $(call Device/UbiFit)
            DEVICE_VENDOR := Xunison
            DEVICE_MODEL := D50-5G
            DEVICE_DTS := ipq5018-xunison-d50-5g
            BLOCKSIZE := 128k
            PAGESIZE := 2048
            KERNEL_SIZE := 8192k
            IMAGE_SIZE := 83968k
            NAND_SIZE := 256m
            SOC := ipq5018
            DEVICE_DTS_CONFIG := config@mp03.1
            SUPPORTED_DEVICES := xunison,d50_5g
            DEVICE_PACKAGES := ipq-wifi-xunison_d50-5g \
              ath11k-firmware-ipq5018 kmod-ath11k-pci \
              ath11k-firmware-qcn9074
          endef
          TARGET_DEVICES += xunison_d50-5g
          EOF

          # 3. Add network config
          cat >> target/linux/qualcommax/ipq50xx/base-files/etc/board.d/02_network << 'EOF'

          xunison,d50_5g)
            ucidef_set_interfaces_lan_wan "lan1 lan2 lan3 lan4" "wan"
            ;;
          EOF

      - name: Add WiFi calibration package
        run: |
          cd openwrt
          mkdir -p package/firmware/ipq-wifi-xunison-d50-5g
          cp ../patches-repo/mainline/ipq-wifi-xunison-d50-5g/Makefile \
            package/firmware/ipq-wifi-xunison-d50-5g/
          cp ../patches-repo/mainline/ipq-wifi-xunison-d50-5g/board-xunison-d50-5g.bin.IPQ5018 \
            package/firmware/ipq-wifi-xunison-d50-5g/
          cp ../patches-repo/mainline/ipq-wifi-xunison-d50-5g/board-xunison-d50-5g.bin.QCN9074 \
            package/firmware/ipq-wifi-xunison-d50-5g/

      - name: Update feeds and add QModem
        run: |
          cd openwrt
          echo "src-git qmodem https://github.com/CaspianGUAN/QModem.git" >> feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          ./scripts/feeds install -a -p qmodem

      - name: Configure build
        run: |
          cd openwrt
          cat > .config << 'EOF'
          CONFIG_TARGET_qualcommax=y
          CONFIG_TARGET_qualcommax_ipq50xx=y
          CONFIG_TARGET_qualcommax_ipq50xx_DEVICE_xunison_d50-5g=y
          CONFIG_PACKAGE_ipq-wifi-xunison_d50-5g=y
          CONFIG_PACKAGE_kmod-ath11k-pci=y
          CONFIG_PACKAGE_ath11k-firmware-ipq5018=y
          CONFIG_PACKAGE_ath11k-firmware-qcn9074=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-app-qmodem=y
          CONFIG_PACKAGE_luci-app-qmodem_USE_TOM_CUSTOMIZED_QUECTEL_CM=y
          CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_generic-qmi-wwan=y
          CONFIG_PACKAGE_luci-app-qmodem_VENDOR_MHI_PCIe_DRIVER=y
          CONFIG_PACKAGE_luci-app-qmodem-sms=y
          CONFIG_PACKAGE_luci-i18n-qmodem-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-qmodem-sms-zh-cn=y
          CONFIG_PACKAGE_qmodem=y
          CONFIG_PACKAGE_tom_modem=y
          CONFIG_PACKAGE_tom_modem_EARLY_RETURN=y
          CONFIG_PACKAGE_tom_modem_ENABLE_UBUS_DAEMON=y
          CONFIG_PACKAGE_ubus-at-daemon=y
          CONFIG_PACKAGE_quectel-CM-5G-M=y
          CONFIG_PACKAGE_sms-tool_q=y
          EOF
          make defconfig

      - name: Download packages
        run: |
          cd openwrt
          make download -j$(nproc) 2>&1 | grep -E "^(ERROR|WARNING)" || true

      - name: Build toolchain
        if: steps.cache-toolchain.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          set -o pipefail
          make toolchain/compile -j$(nproc) 2>&1 | tail -5

      - name: Build firmware
        run: |
          cd openwrt
          set -o pipefail
          make -j$(nproc) 2>&1 | tail -30 || {
            echo "=== Parallel build failed, running verbose ==="
            make -j1 V=s 2>&1 | tail -200
          }

      - name: Show output files
        if: always()
        run: |
          echo "=== Firmware output ==="
          find openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/ \
            -type f -name "*.ubi" -o -name "*.bin" -o -name "*.tar" \
            2>/dev/null | sort || echo "No firmware found"
          df -h

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: xunison-d50-5g-mainline-qmodem-${{ github.run_number }}
          path: openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/
          retention-days: 14
