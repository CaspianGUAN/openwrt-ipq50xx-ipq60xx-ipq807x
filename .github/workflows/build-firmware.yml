name: Build Xunison D50-5G Firmware with QModem

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'openwrt/**'
      - '.github/workflows/build-firmware.yml'

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 330

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/local/share/boost /opt/hostedtoolcache/CodeQL \
            /usr/lib/jvm /usr/share/swift /usr/local/go
          sudo apt-get clean
          df -h

      - name: Install build dependencies
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev \
            libssl-dev python3-distutils rsync unzip zlib1g-dev \
            file wget curl libelf-dev python2 python2-dev \
            swig device-tree-compiler u-boot-tools
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

      - name: Cache toolchain
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: ${{ runner.os }}-toolchain-ipq50xx-${{ hashFiles('openwrt/toolchain/**/*.mk', 'openwrt/include/toolchain.mk') }}
          restore-keys: |
            ${{ runner.os }}-toolchain-ipq50xx-

      - name: Update and install QModem feed
        run: |
          cd openwrt
          ./scripts/feeds update qmodem
          ./scripts/feeds install -a -p qmodem

      - name: Run defconfig
        run: |
          cd openwrt
          make defconfig

      - name: Download packages
        run: |
          cd openwrt
          make download -j$(nproc) 2>&1 | grep -v "^make\[" || true

      - name: Build toolchain
        if: steps.cache-toolchain.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          make toolchain/compile -j$(nproc) V=s 2>&1 | tail -20

      - name: Build firmware
        run: |
          cd openwrt
          make -j$(nproc) 2>&1 | tail -50 || make -j1 V=s 2>&1 | tail -200

      - name: Show output files
        if: always()
        run: |
          echo "=== Firmware files ==="
          find openwrt/bin/targets/ipq807x/ipq50xx/ -type f 2>/dev/null || echo "No firmware output"
          echo "=== Disk usage ==="
          df -h

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: xunison-d50-5g-qmodem-${{ github.run_number }}
          path: openwrt/bin/targets/ipq807x/ipq50xx/
          retention-days: 14
